-- Migration: Add structured vulnerability fields to submission_vulnerabilities table
-- Run this in Supabase SQL Editor
-- This adds support for Questions, What/So What structure, Sector, and Subsector

-- Add columns if they don't exist
DO $$ 
BEGIN
  -- question: Assessment question for the vulnerability
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_schema = 'public' AND table_name = 'submission_vulnerabilities' AND column_name = 'question'
  ) THEN
    ALTER TABLE public.submission_vulnerabilities ADD COLUMN question text;
    COMMENT ON COLUMN public.submission_vulnerabilities.question IS 'Assessment question in proper question format (e.g., "Are there adequate...?")';
  END IF;

  -- what: Clear description of the vulnerability in sentence format
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_schema = 'public' AND table_name = 'submission_vulnerabilities' AND column_name = 'what'
  ) THEN
    ALTER TABLE public.submission_vulnerabilities ADD COLUMN what text;
    COMMENT ON COLUMN public.submission_vulnerabilities.what IS 'Clear description of the vulnerability in sentence format';
  END IF;

  -- so_what: Impact, consequence, or risk if this vulnerability is not addressed
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_schema = 'public' AND table_name = 'submission_vulnerabilities' AND column_name = 'so_what'
  ) THEN
    ALTER TABLE public.submission_vulnerabilities ADD COLUMN so_what text;
    COMMENT ON COLUMN public.submission_vulnerabilities.so_what IS 'Impact, consequence, or risk if this vulnerability is not addressed';
  END IF;

  -- sector: Primary sector classification (e.g., Education, Healthcare, Energy)
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_schema = 'public' AND table_name = 'submission_vulnerabilities' AND column_name = 'sector'
  ) THEN
    ALTER TABLE public.submission_vulnerabilities ADD COLUMN sector varchar(256);
    COMMENT ON COLUMN public.submission_vulnerabilities.sector IS 'Primary sector (e.g., Education, Healthcare, Energy, Government Facilities, Transportation, Water)';
  END IF;

  -- subsector: Specific subsector within the sector
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_schema = 'public' AND table_name = 'submission_vulnerabilities' AND column_name = 'subsector'
  ) THEN
    ALTER TABLE public.submission_vulnerabilities ADD COLUMN subsector varchar(256);
    COMMENT ON COLUMN public.submission_vulnerabilities.subsector IS 'Specific subsector within the sector (e.g., K-12 Schools, Hospitals, Power Generation, Federal Buildings)';
  END IF;

  -- Note: If you have sectors and subsectors tables with IDs, consider adding:
  -- sector_id uuid REFERENCES sectors(id),
  -- subsector_id uuid REFERENCES subsectors(id),
  -- This would allow for better referential integrity and easier queries
END $$;

-- Add indexes for faster queries and filtering
CREATE INDEX IF NOT EXISTS idx_submission_vulnerabilities_sector ON public.submission_vulnerabilities(sector);
CREATE INDEX IF NOT EXISTS idx_submission_vulnerabilities_subsector ON public.submission_vulnerabilities(subsector);
CREATE INDEX IF NOT EXISTS idx_submission_vulnerabilities_discipline ON public.submission_vulnerabilities(discipline) WHERE discipline IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_submission_vulnerabilities_question ON public.submission_vulnerabilities USING gin(to_tsvector('english', question)) WHERE question IS NOT NULL;

-- Grant necessary permissions
-- GRANT SELECT, INSERT, UPDATE ON submission_vulnerabilities TO authenticated;
-- GRANT ALL ON submission_vulnerabilities TO service_role;

