<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOFC Processing Dashboard - Embeddable</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #0d1117;
            color: #00ff95;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .dashboard-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
        }
        
        .dashboard-title {
            font-size: 18px;
            font-weight: bold;
            color: #58a6ff;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f85149;
        }
        
        .status-dot.connected {
            background: #3fb950;
        }
        
        .mode-selector {
            background: #21262d;
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: inherit;
        }
        
        .console-output {
            background: #000000;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.3;
        }
        
        .console-output::-webkit-scrollbar {
            width: 8px;
        }
        
        .console-output::-webkit-scrollbar-track {
            background: #21262d;
        }
        
        .console-output::-webkit-scrollbar-thumb {
            background: #6e7681;
            border-radius: 4px;
        }
        
        .console-output::-webkit-scrollbar-thumb:hover {
            background: #8b949e;
        }
        
        .log-entry {
            margin-bottom: 2px;
        }
        
        .log-entry.error {
            color: #f85149;
        }
        
        .log-entry.warning {
            color: #d29922;
        }
        
        .log-entry.success {
            color: #3fb950;
        }
        
        .log-entry.stage {
            color: #58a6ff;
        }
        
        .log-entry.metrics {
            color: #a5a5a5;
        }
        
        .log-entry.system {
            color: #79c0ff;
        }
        
        .stats-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #8b949e;
        }
        
        .loading {
            text-align: center;
            color: #58a6ff;
            padding: 20px;
        }
        
        .no-logs {
            text-align: center;
            color: #6e7681;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .console-output {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="dashboard-title">VOFC Processing Dashboard</div>
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Disconnected</span>
                <select class="mode-selector" id="modeSelector">
                    <option value="live">Live Mode</option>
                    <option value="ollama-only">Ollama Only</option>
                </select>
            </div>
        </div>
        
        <div class="console-output" id="consoleOutput">
            <div class="no-logs">No logs yet. Select a mode to start monitoring.</div>
        </div>
        
        <div class="stats-footer">
            <span>Logs: <span id="logCount">0</span></span>
            <span>Mode: <span id="currentMode">demo</span></span>
            <span>Last updated: <span id="lastUpdate">Never</span></span>
        </div>
    </div>

    <script>
        class OllamaDashboard {
            constructor() {
                this.logDiv = document.getElementById('consoleOutput');
                this.statusDot = document.getElementById('statusDot');
                this.statusText = document.getElementById('statusText');
                this.modeSelector = document.getElementById('modeSelector');
                this.logCount = document.getElementById('logCount');
                this.currentMode = document.getElementById('currentMode');
                this.lastUpdate = document.getElementById('lastUpdate');
                
                this.eventSource = null;
                this.logs = [];
                this.isConnected = false;
                
                this.init();
            }
            
            init() {
                this.modeSelector.addEventListener('change', (e) => {
                    this.connect(e.target.value);
                });
                
                // Start with live mode
                this.connect('live');
            }
            
            connect(mode) {
                this.disconnect();
                
                this.statusText.textContent = 'Connecting...';
                this.statusDot.classList.remove('connected');
                this.logs = [];
                this.updateDisplay();
                
                const url = `/api/dashboard/stream?mode=${mode}`;
                this.eventSource = new EventSource(url);
                
                this.eventSource.onopen = () => {
                    this.isConnected = true;
                    this.statusText.textContent = 'Connected';
                    this.statusDot.classList.add('connected');
                };
                
                this.eventSource.onmessage = (event) => {
                    this.addLog(event.data);
                };
                
                this.eventSource.onerror = (error) => {
                    console.error('EventSource error:', error);
                    this.isConnected = false;
                    this.statusText.textContent = 'Disconnected';
                    this.statusDot.classList.remove('connected');
                    this.eventSource.close();
                };
                
                this.currentMode.textContent = mode;
            }
            
            disconnect() {
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                }
                this.isConnected = false;
            }
            
            addLog(logEntry) {
                this.logs.push(logEntry);
                this.updateDisplay();
                this.scrollToBottom();
                this.updateLastUpdate();
            }
            
            updateDisplay() {
                if (this.logs.length === 0) {
                    this.logDiv.innerHTML = '<div class="no-logs">No logs yet. Select a mode to start monitoring.</div>';
                    return;
                }
                
                const html = this.logs.map(log => {
                    const logClass = this.getLogClass(log);
                    return `<div class="log-entry ${logClass}">${this.escapeHtml(log)}</div>`;
                }).join('');
                
                this.logDiv.innerHTML = html;
                this.logCount.textContent = this.logs.length;
            }
            
            getLogClass(logEntry) {
                if (logEntry.includes('[ERROR]')) return 'error';
                if (logEntry.includes('[WARNING]')) return 'warning';
                if (logEntry.includes('[SUCCESS]')) return 'success';
                if (logEntry.includes('[STAGE]')) return 'stage';
                if (logEntry.includes('[METRICS]')) return 'metrics';
                if (logEntry.includes('[SYSTEM]')) return 'system';
                return '';
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            scrollToBottom() {
                setTimeout(() => {
                    this.logDiv.scrollTop = this.logDiv.scrollHeight;
                }, 50);
            }
            
            updateLastUpdate() {
                this.lastUpdate.textContent = new Date().toLocaleTimeString();
            }
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new OllamaDashboard();
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.dashboard) {
                window.dashboard.disconnect();
            }
        });
    </script>
</body>
</html>
